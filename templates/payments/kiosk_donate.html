{% extends 'base.html' %}
{% load i18n static custom_tags %}

{% block content %}
<div class="content-body">
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-xl-8 col-lg-10">
                <div class="card">
                    <div class="card-header text-center bg-primary text-white">
                        <h2 class="mb-0">{% trans "Faire un don" %}</h2>
                    </div>
                    <div class="card-body p-5">
                        <div class="row mb-4">
                            {% for amt in suggested_amounts %}
                            <div class="col-4 mb-3">
                                <button type="button" class="btn btn-outline-primary btn-lg w-100 py-4 kiosk-amount-btn" data-amount="{{ amt }}" style="font-size: 1.5rem;">
                                    ${{ amt }}
                                </button>
                            </div>
                            {% endfor %}
                        </div>

                        <div class="mb-4">
                            <label class="form-label fs-5">{% trans "Autre montant" %}</label>
                            <div class="input-group input-group-lg">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="kiosk-amount" min="1" step="0.01" placeholder="0.00" style="font-size: 1.5rem;">
                            </div>
                        </div>

                        <div id="kiosk-card-element" class="form-control mb-4 p-3" style="min-height: 50px;"></div>
                        <div id="kiosk-errors" class="text-danger mb-3"></div>

                        <button type="button" id="kiosk-submit" class="btn btn-success btn-lg w-100 py-3" style="font-size: 1.5rem;">
                            <i class="fa fa-credit-card me-2"></i>{% trans "Payer" %}
                        </button>

                        <div id="kiosk-success" class="text-center mt-4" style="display: none;">
                            <i class="fa fa-check-circle text-success" style="font-size: 5rem;"></i>
                            <h2 class="mt-3">{% trans "Merci!" %}</h2>
                            <p class="text-muted">{% trans "Votre don a été traité avec succès." %}</p>
                            <button type="button" class="btn btn-primary btn-lg mt-3" onclick="window.location.reload()">
                                {% trans "Nouveau don" %}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block additional_js %}
{% if stripe_public_key %}
<script src="https://js.stripe.com/v3/"></script>
<script>
const stripe = Stripe('{{ stripe_public_key }}');
const elements = stripe.elements();
const cardElement = elements.create('card', {style: {base: {fontSize: '18px'}}});
cardElement.mount('#kiosk-card-element');

document.querySelectorAll('.kiosk-amount-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.getElementById('kiosk-amount').value = this.dataset.amount;
        document.querySelectorAll('.kiosk-amount-btn').forEach(b => b.classList.remove('active', 'btn-primary'));
        document.querySelectorAll('.kiosk-amount-btn').forEach(b => b.classList.add('btn-outline-primary'));
        this.classList.remove('btn-outline-primary');
        this.classList.add('active', 'btn-primary');
    });
});

document.getElementById('kiosk-submit').addEventListener('click', async function() {
    const amount = document.getElementById('kiosk-amount').value;
    if (!amount || parseFloat(amount) < 1) {
        document.getElementById('kiosk-errors').textContent = 'Veuillez entrer un montant valide.';
        return;
    }
    this.disabled = true;
    this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Traitement...';

    try {
        const csrfToken = document.cookie.match(/csrftoken=([^;]+)/)?.[1] || '';
        const response = await fetch('/api/v1/payments/payments/create_intent/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
            body: JSON.stringify({amount, donation_type: 'offering'}),
        });
        const data = await response.json();
        const {error} = await stripe.confirmCardPayment(data.client_secret, {payment_method: {card: cardElement}});
        if (error) {
            document.getElementById('kiosk-errors').textContent = error.message;
        } else {
            document.getElementById('kiosk-success').style.display = 'block';
            document.getElementById('kiosk-submit').style.display = 'none';
        }
    } catch (err) {
        document.getElementById('kiosk-errors').textContent = err.message;
    } finally {
        this.disabled = false;
        this.innerHTML = '<i class="fa fa-credit-card me-2"></i>Payer';
    }
});
</script>
{% endif %}
{% endblock %}
