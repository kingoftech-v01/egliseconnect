<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EgliseConnect - Kiosque</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background: #1a1a2e; color: #fff; min-height: 100vh; overflow: hidden; }
        .kiosk-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 2rem; }
        .kiosk-title { font-size: 2.5rem; margin-bottom: 0.5rem; }
        .kiosk-subtitle { font-size: 1.2rem; opacity: 0.7; margin-bottom: 3rem; }
        .kiosk-btn { font-size: 1.5rem; padding: 1.5rem 3rem; border-radius: 1rem; margin: 0.5rem; min-width: 300px; }
        .search-container { max-width: 600px; width: 100%; }
        .search-input { font-size: 1.5rem; padding: 1rem 1.5rem; border-radius: 1rem; }
        .member-result { cursor: pointer; padding: 1rem; border-radius: 0.5rem; transition: background 0.2s; }
        .member-result:hover { background: rgba(255,255,255,0.1); }
        .success-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,128,0,0.9); display: none; z-index: 9999; }
        .success-overlay.show { display: flex; align-items: center; justify-content: center; flex-direction: column; }
        #idle-timer { position: fixed; bottom: 1rem; right: 1rem; opacity: 0.5; font-size: 0.9rem; }
    </style>
</head>
<body>
    <!-- Success Overlay -->
    <div id="success-overlay" class="success-overlay">
        <i class="bi bi-check-circle" style="font-size: 8rem;"></i>
        <h1 id="success-name" class="mt-3"></h1>
        <p class="fs-4">Presence enregistree!</p>
    </div>

    <div class="kiosk-container" id="main-screen">
        <h1 class="kiosk-title">EgliseConnect</h1>
        <p class="kiosk-subtitle">{{ kiosk.name }} - {{ kiosk.location }}</p>

        <!-- Session Info -->
        {% if kiosk.session %}
        <div class="alert alert-info mb-4 text-center" style="max-width: 600px;">
            <strong>{{ kiosk.session.name }}</strong> - {{ kiosk.session.date|date:"d/m/Y" }}
        </div>
        {% endif %}

        <!-- Action Buttons -->
        <div id="action-buttons" class="text-center">
            <button class="kiosk-btn btn btn-primary d-block" onclick="showSearch('member')">
                <i class="bi bi-person-check me-2"></i>Enregistrement individuel
            </button>
            <button class="kiosk-btn btn btn-success d-block" onclick="showSearch('family')">
                <i class="bi bi-people me-2"></i>Enregistrement famille
            </button>
            <button class="kiosk-btn btn btn-warning d-block" onclick="showQRScanner()">
                <i class="bi bi-qr-code-scan me-2"></i>Scanner QR
            </button>
        </div>

        <!-- Search Screen -->
        <div id="search-screen" class="search-container d-none">
            <button class="btn btn-outline-light mb-3" onclick="showMain()"><i class="bi bi-arrow-left me-1"></i>Retour</button>
            <input type="text" id="search-input" class="form-control search-input" placeholder="Entrez votre nom..." autocomplete="off">
            <div id="search-results" class="mt-3"></div>
        </div>

        <!-- Family Members Selection -->
        <div id="family-screen" class="search-container d-none">
            <button class="btn btn-outline-light mb-3" onclick="showSearch('family')"><i class="bi bi-arrow-left me-1"></i>Retour</button>
            <h3 id="family-name" class="mb-3"></h3>
            <div id="family-members"></div>
            <button class="btn btn-success btn-lg w-100 mt-3" onclick="submitFamilyCheckin()">
                <i class="bi bi-check-all me-2"></i>Enregistrer la selection
            </button>
        </div>

        <!-- QR Scanner -->
        <div id="qr-screen" class="search-container d-none">
            <button class="btn btn-outline-light mb-3" onclick="showMain()"><i class="bi bi-arrow-left me-1"></i>Retour</button>
            <div id="kiosk-qr-reader" style="width: 100%; max-width: 400px; margin: 0 auto;"></div>
        </div>
    </div>

    <div id="idle-timer">Retour automatique dans <span id="idle-countdown">{{ kiosk.auto_timeout_seconds }}</span>s</div>

    <!-- Admin PIN access -->
    <div style="position: fixed; bottom: 1rem; left: 1rem;">
        <a href="/attendance/kiosk/{{ kiosk.pk }}/admin/" class="btn btn-sm btn-outline-secondary opacity-25"><i class="bi bi-gear"></i></a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    var kioskId = '{{ kiosk.pk }}';
    var timeoutSeconds = {{ kiosk.auto_timeout_seconds }};
    var idleTimer = null;
    var countdown = timeoutSeconds;
    var searchMode = 'member';
    var selectedFamilyId = null;

    function resetIdleTimer() {
        countdown = timeoutSeconds;
        document.getElementById('idle-countdown').textContent = countdown;
        if (idleTimer) clearInterval(idleTimer);
        idleTimer = setInterval(function() {
            countdown--;
            document.getElementById('idle-countdown').textContent = countdown;
            if (countdown <= 0) {
                clearInterval(idleTimer);
                showMain();
            }
        }, 1000);
    }

    document.addEventListener('click', resetIdleTimer);
    document.addEventListener('keydown', resetIdleTimer);
    document.addEventListener('touchstart', resetIdleTimer);
    resetIdleTimer();

    function showMain() {
        document.getElementById('action-buttons').classList.remove('d-none');
        document.getElementById('search-screen').classList.add('d-none');
        document.getElementById('family-screen').classList.add('d-none');
        document.getElementById('qr-screen').classList.add('d-none');
        resetIdleTimer();
    }

    function showSearch(mode) {
        searchMode = mode;
        document.getElementById('action-buttons').classList.add('d-none');
        document.getElementById('search-screen').classList.remove('d-none');
        document.getElementById('family-screen').classList.add('d-none');
        document.getElementById('qr-screen').classList.add('d-none');
        document.getElementById('search-input').value = '';
        document.getElementById('search-results').innerHTML = '';
        document.getElementById('search-input').placeholder = mode === 'family' ? 'Nom de famille...' : 'Votre nom...';
        document.getElementById('search-input').focus();
        resetIdleTimer();
    }

    function showQRScanner() {
        document.getElementById('action-buttons').classList.add('d-none');
        document.getElementById('qr-screen').classList.remove('d-none');
        resetIdleTimer();
    }

    var searchTimeout = null;
    document.getElementById('search-input').addEventListener('input', function() {
        resetIdleTimer();
        clearTimeout(searchTimeout);
        var q = this.value.trim();
        if (q.length < 2) { document.getElementById('search-results').innerHTML = ''; return; }
        searchTimeout = setTimeout(function() {
            var url = searchMode === 'family'
                ? '/attendance/kiosk/' + kioskId + '/family-search/?q=' + encodeURIComponent(q)
                : '/attendance/kiosk/' + kioskId + '/search/?q=' + encodeURIComponent(q);
            fetch(url).then(function(r) { return r.json(); }).then(function(data) {
                var html = '';
                data.results.forEach(function(item) {
                    if (searchMode === 'family') {
                        var membersHtml = item.members.map(function(m) { return m.name; }).join(', ');
                        html += '<div class="member-result border-bottom" onclick="selectFamily(\'' + item.id + '\', \'' + item.name + '\', ' + JSON.stringify(item.members).replace(/"/g, '&quot;') + ')">';
                        html += '<h5>' + item.name + '</h5><small class="text-muted">' + membersHtml + '</small></div>';
                    } else {
                        html += '<div class="member-result border-bottom" onclick="checkinMember(\'' + item.id + '\')">';
                        html += '<h5>' + item.full_name + '</h5><small class="text-muted">' + item.member_number + '</small></div>';
                    }
                });
                if (!html) html = '<p class="text-muted text-center mt-3">Aucun resultat</p>';
                document.getElementById('search-results').innerHTML = html;
            });
        }, 300);
    });

    function checkinMember(memberId) {
        var formData = new FormData();
        formData.append('member_id', memberId);
        fetch('/attendance/kiosk/' + kioskId + '/checkin/', { method: 'POST', body: formData })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success || data.warning) {
                showSuccess(data.member_name || data.message);
            } else {
                alert(data.error || 'Erreur');
            }
        });
    }

    function selectFamily(familyId, familyName, members) {
        selectedFamilyId = familyId;
        document.getElementById('search-screen').classList.add('d-none');
        document.getElementById('family-screen').classList.remove('d-none');
        document.getElementById('family-name').textContent = 'Famille ' + familyName;
        var html = '';
        members.forEach(function(m) {
            html += '<div class="form-check form-check-lg p-3 border-bottom">';
            html += '<input class="form-check-input family-member-cb" type="checkbox" value="' + m.id + '" id="member-' + m.id + '" checked style="width: 2rem; height: 2rem;">';
            html += '<label class="form-check-label fs-4 ms-3" for="member-' + m.id + '">' + m.name + '</label>';
            html += '</div>';
        });
        document.getElementById('family-members').innerHTML = html;
        resetIdleTimer();
    }

    function submitFamilyCheckin() {
        var formData = new FormData();
        formData.append('family_id', selectedFamilyId);
        document.querySelectorAll('.family-member-cb:checked').forEach(function(cb) {
            formData.append('member_ids', cb.value);
        });
        fetch('/attendance/kiosk/' + kioskId + '/family-checkin/', { method: 'POST', body: formData })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                var names = data.checked_in.join(', ') || 'Deja enregistres';
                showSuccess(names);
            } else {
                alert(data.error || 'Erreur');
            }
        });
    }

    function showSuccess(name) {
        document.getElementById('success-name').textContent = name;
        var overlay = document.getElementById('success-overlay');
        overlay.classList.add('show');
        // Play success sound (item 23)
        try {
            var audio = new Audio('data:audio/wav;base64,UklGRl9vT19teleWQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU');
            audio.play().catch(function(){});
        } catch(e) {}
        setTimeout(function() {
            overlay.classList.remove('show');
            showMain();
        }, 3000);
    }
    </script>
</body>
</html>
