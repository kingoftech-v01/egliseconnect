{% extends 'base.html' %}
{% load static custom_tags %}
{% block content %}
<div class="content-body">
    <div class="page-titles">
        <ol class="breadcrumb">
            <li><h5 class="bc-title">Tableau de bord</h5></li>
            <li class="breadcrumb-item"><a href="/reports/">Accueil</a></li>
            <li class="breadcrumb-item active"><a href="javascript:void(0)">Tableau de bord</a></li>
        </ol>
    </div>
    <div class="container-fluid">
        <!-- Stat Cards Row 1 -->
        <div class="row">
            <div class="col-xl-3 col-sm-6">
                <div class="card chart-grd same-card">
                    <div class="card-body depostit-card p-0">
                        <div class="depostit-card-media d-flex justify-content-between pb-0">
                            <div>
                                <h6>Membres total</h6>
                                <h3>{{ summary.members.total }}</h3>
                            </div>
                            <div class="icon-box bg-primary-light">
                                <i class="bi bi-people"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-sm-6">
                <div class="card chart-grd same-card">
                    <div class="card-body depostit-card p-0">
                        <div class="depostit-card-media d-flex justify-content-between pb-0">
                            <div>
                                <h6>Membres actifs</h6>
                                <h3>{{ summary.members.active }}</h3>
                            </div>
                            <div class="icon-box bg-success-light">
                                <i class="bi bi-person-check"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-sm-6">
                <div class="card chart-grd same-card">
                    <div class="card-body depostit-card p-0">
                        <div class="depostit-card-media d-flex justify-content-between pb-0">
                            <div>
                                <h6>Dons total $</h6>
                                <h3>{{ summary.donations.total_amount|floatformat:2 }} $</h3>
                            </div>
                            <div class="icon-box bg-warning-light">
                                <i class="bi bi-cash-stack"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-sm-6">
                <div class="card chart-grd same-card">
                    <div class="card-body depostit-card p-0">
                        <div class="depostit-card-media d-flex justify-content-between pb-0">
                            <div>
                                <h6>Events a venir</h6>
                                <h3>{{ summary.events.upcoming }}</h3>
                            </div>
                            <div class="icon-box bg-info-light">
                                <i class="bi bi-calendar-event"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Stat Cards Row 2 -->
        <div class="row">
            <div class="col-xl-3 col-sm-6">
                <div class="card chart-grd same-card">
                    <div class="card-body depostit-card p-0">
                        <div class="depostit-card-media d-flex justify-content-between pb-0">
                            <div>
                                <h6>Volontaires positions</h6>
                                <h3>{{ summary.volunteers.total_positions }}</h3>
                            </div>
                            <div class="icon-box bg-secondary-light">
                                <i class="bi bi-hand-thumbs-up"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-sm-6">
                <div class="card chart-grd same-card">
                    <div class="card-body depostit-card p-0">
                        <div class="depostit-card-media d-flex justify-content-between pb-0">
                            <div>
                                <h6>Demandes ouvertes</h6>
                                <h3>{{ summary.help_requests.open }}</h3>
                            </div>
                            <div class="icon-box bg-danger-light">
                                <i class="bi bi-exclamation-triangle"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Action Buttons -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="heading mb-0">Actions rapides</h4>
                    </div>
                    <div class="card-body">
                        <div class="d-flex flex-wrap gap-2">
                            <a href="/events/create/" class="btn btn-primary btn-sm">
                                <i class="bi bi-calendar-plus me-1"></i>Creer un evenement
                            </a>
                            <a href="/attendance/sessions/create/" class="btn btn-info btn-sm">
                                <i class="bi bi-qr-code me-1"></i>Creer une session
                            </a>
                            <a href="/communication/newsletters/create/" class="btn btn-success btn-sm">
                                <i class="bi bi-envelope me-1"></i>Envoyer un bulletin
                            </a>
                            <a href="/members/register/" class="btn btn-warning btn-sm">
                                <i class="bi bi-person-plus me-1"></i>Nouveau membre
                            </a>
                            <a href="/reports/export/members/" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-download me-1"></i>Exporter membres (CSV)
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Onboarding Pipeline Widget + Financial Summary -->
        <div class="row">
            <!-- Onboarding Pipeline Widget -->
            <div class="col-xl-6 col-lg-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="heading mb-0">Pipeline d'adhesion</h4>
                        <a href="/onboarding/admin/pipeline/" class="btn btn-outline-primary btn-xs">Voir le pipeline</a>
                    </div>
                    <div class="card-body">
                        {% if onboarding_pipeline %}
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between">
                                <span><span class="badge bg-secondary me-2">Inscrits</span></span>
                                <strong>{{ onboarding_pipeline.registered }}</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span><span class="badge bg-warning text-dark me-2">Formulaire soumis</span></span>
                                <strong>{{ onboarding_pipeline.form_submitted }}</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span><span class="badge bg-primary me-2">En formation</span></span>
                                <strong>{{ onboarding_pipeline.in_training }}</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span><span class="badge bg-info me-2">Interview planifiee</span></span>
                                <strong>{{ onboarding_pipeline.interview_scheduled }}</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span><strong>Total en cours</strong></span>
                                <strong class="text-primary">{{ onboarding_pipeline.total_in_process }}</strong>
                            </li>
                        </ul>
                        {% else %}
                        <p class="text-muted">Aucune donnee disponible.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Financial Summary Widget -->
            <div class="col-xl-6 col-lg-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="heading mb-0">Tendance financiere (6 mois)</h4>
                        <a href="/reports/donations/" class="btn btn-outline-primary btn-xs">Rapport complet</a>
                    </div>
                    <div class="card-body">
                        <canvas id="financialTrendChart" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Member Growth Trend Chart -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="heading mb-0">Croissance des membres (12 mois)</h4>
                    </div>
                    <div class="card-body">
                        <canvas id="memberGrowthChart" height="120"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Stats + Role Breakdown -->
        <div class="row">
            <div class="col-xl-6 col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h4 class="heading mb-0">Statistiques rapides</h4>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Nouveaux membres ce mois</span>
                                <strong>{{ summary.members.new_this_month }}</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Nouveaux membres cette annee</span>
                                <strong>{{ summary.members.new_this_year }}</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Membres inactifs</span>
                                <strong>{{ summary.members.inactive }}</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Nombre total de dons ({{ summary.donations.year }})</span>
                                <strong>{{ summary.donations.total_count }}</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Don moyen</span>
                                <strong>{{ summary.donations.average_amount|floatformat:2 }} $</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Events annules ({{ summary.events.year }})</span>
                                <strong>{{ summary.events.cancelled }}</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Horaires volontaires a venir</span>
                                <strong>{{ summary.volunteers.upcoming_schedules }}</strong>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Demandes d'aide total</span>
                                <strong>{{ summary.help_requests.total }}</strong>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Role Breakdown -->
            <div class="col-xl-6 col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h4 class="heading mb-0">Repartition par role</h4>
                    </div>
                    <div class="card-body">
                        {% if summary.members.role_breakdown %}
                        <ul class="list-group list-group-flush">
                            {% for item in summary.members.role_breakdown %}
                            <li class="list-group-item d-flex justify-content-between">
                                <span>{{ item.role }}</span>
                                <strong>{{ item.count }}</strong>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <p class="text-muted">Aucune donnee disponible.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Upcoming Birthdays -->
        {% if summary.upcoming_birthdays %}
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive active-projects style-1">
                            <div class="tbl-caption">
                                <h4 class="heading mb-0">Anniversaires a venir</h4>
                            </div>
                            <table id="birthday-table" class="table">
                                <thead>
                                    <tr>
                                        <th>Nom</th>
                                        <th>Date d'anniversaire</th>
                                        <th>Age</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for bd in summary.upcoming_birthdays %}
                                    <tr>
                                        <td>{{ bd.member_name }}</td>
                                        <td>{{ bd.birthday }}</td>
                                        <td>{% if bd.age %}{{ bd.age }} ans{% else %}-{% endif %}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="row">
            <div class="col-12">
                <p class="text-muted text-end">Genere le : {{ summary.generated_at }}</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block additional_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Financial Trend Chart
var finCtx = document.getElementById('financialTrendChart');
if (finCtx) {
    var finData = {{ financial_summary.labels|safe }};
    var finValues = {{ financial_summary.values|safe }};
    new Chart(finCtx.getContext('2d'), {
        type: 'bar',
        data: {
            labels: finData || [],
            datasets: [{
                label: 'Dons ($)',
                data: finValues || [],
                backgroundColor: 'rgba(25, 135, 84, 0.7)',
                borderColor: '#198754',
                borderWidth: 1,
                borderRadius: 4,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

// Member Growth Trend Chart
var growthCtx = document.getElementById('memberGrowthChart');
if (growthCtx) {
    var growthData = JSON.parse('{{ growth_data_json|escapejs }}');
    new Chart(growthCtx.getContext('2d'), {
        type: 'line',
        data: {
            labels: growthData.labels || [],
            datasets: [{
                label: 'Nouveaux membres',
                data: growthData.counts || [],
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                fill: true,
                tension: 0.3,
                pointRadius: 4,
                pointHoverRadius: 6,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, ticks: { stepSize: 1 } }
            }
        }
    });
}
</script>
{% endblock %}
