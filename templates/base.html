<!DOCTYPE html>
<html lang="fr">
    <head>
        {% load static custom_tags %}
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="{{ dz_array.public.description }}">
        <title>{% block title %}{{ dz_array.public.title }}{% endblock %}</title>
        <link rel="shortcut icon" type="image/png" href="{% static dz_array.public.favicon %}">
        <!-- PWA -->
        <meta name="theme-color" content="#1a73e8">
        <link rel="manifest" href="/manifest.json">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="default">
        <meta name="apple-mobile-web-app-title" content="Ã‰gliseConnect">
        {% for cssurl in dz_array.pagelevel.w3crm.w3crm_views.css|getdata:request.path %}
        <link rel="stylesheet" href="{% static cssurl %}">
        {% endfor %}
        {% for cssurl in dz_array.global.css %}
        <link rel="stylesheet" href="{% static cssurl %}">
        {% endfor %}
        {% block additional_css %}{% endblock %}
    </head>
    <body data-typography="poppins" data-layout="vertical" data-nav-headerbg="black" data-headerbg="color_1">

    <div id="preloader">
        <div class="lds-ripple">
            <div></div>
            <div></div>
        </div>
    </div>

    <div id="main-wrapper">
        {% include 'elements/nav-header.html' %}
        {% include 'elements/header.html' %}
        {% include 'elements/sidebar.html' %}

        {% if messages %}
        <div id="django-messages" style="position:fixed;top:70px;right:20px;z-index:9999;max-width:400px;width:100%;">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        </div>
        <script>
        setTimeout(function(){
            var el = document.getElementById('django-messages');
            if(el) el.style.transition='opacity 0.5s', el.style.opacity='0';
            setTimeout(function(){ if(el) el.remove(); }, 600);
        }, 4000);
        </script>
        {% endif %}

        {% block content %}{% endblock %}

        {% include 'elements/footer.html' %}
    </div>

    {% for jsurl in dz_array.global.js.top %}
    <script src="{% static jsurl %}"></script>
    {% endfor %}
    {% for jsurl in dz_array.pagelevel.w3crm.w3crm_views.js|getdata:request.path %}
    <script src="{% static jsurl %}"></script>
    {% endfor %}
    {% for jsurl in dz_array.global.js.bottom %}
    <script src="{% static jsurl %}"></script>
    {% endfor %}
    {% block additional_js %}{% endblock %}
    <!-- PWA Install Banner -->
    <div id="pwa-install-banner" style="display:none; position:fixed; bottom:0; left:0; right:0; z-index:9999; background:#1a73e8; color:#fff; padding:12px 20px; box-shadow:0 -2px 10px rgba(0,0,0,0.2);">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
            <div class="d-flex align-items-center gap-2">
                <i class="bi bi-download" style="font-size:1.3rem;"></i>
                <span>Installez EgliseConnect pour un acces rapide hors ligne</span>
            </div>
            <div class="d-flex gap-2">
                <button type="button" id="pwa-install-btn" class="btn btn-light btn-sm">Installer</button>
                <button type="button" id="pwa-dismiss-btn" class="btn btn-outline-light btn-sm">Plus tard</button>
            </div>
        </div>
    </div>

    <!-- PWA Service Worker + Install Prompt -->
    <script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').catch(() => {});
    }

    // PWA Install prompt
    var deferredPrompt = null;
    var installBanner = document.getElementById('pwa-install-banner');
    var installBtn = document.getElementById('pwa-install-btn');
    var dismissBtn = document.getElementById('pwa-dismiss-btn');

    window.addEventListener('beforeinstallprompt', function(e) {
        e.preventDefault();
        deferredPrompt = e;
        // Check if user previously dismissed
        if (localStorage.getItem('pwa-install-dismissed') !== 'true') {
            installBanner.style.display = 'block';
        }
    });

    if (installBtn) {
        installBtn.addEventListener('click', function() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(function(choiceResult) {
                    if (choiceResult.outcome === 'accepted') {
                        installBanner.style.display = 'none';
                    }
                    deferredPrompt = null;
                });
            }
        });
    }

    if (dismissBtn) {
        dismissBtn.addEventListener('click', function() {
            installBanner.style.display = 'none';
            localStorage.setItem('pwa-install-dismissed', 'true');
        });
    }

    // Hide banner if app is already installed
    window.addEventListener('appinstalled', function() {
        installBanner.style.display = 'none';
        deferredPrompt = null;
    });
    </script>

</body>
</html>
