{% load static %}
<div class="deznav">
    <div class="deznav-scroll">
        <ul class="metismenu" id="menu">
            <li class="menu-title">EGLISECONNECT</li>

            {% if request.user.is_authenticated %}
            {% with mp=request.user.member_profile %}
            {% if mp %}

            {# Mon profil - always visible #}
            <li><a href="/members/my-profile/" aria-expanded="false">
                <div class="menu-icon"><svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="7" r="4" stroke="#888888"/><path d="M3 18c0-3.87 3.13-7 7-7s7 3.13 7 7" stroke="#888888" stroke-linecap="round"/></svg></div>
                <span class="nav-text">Mon profil</span>
            </a></li>

            {# QR Code - always visible #}
            <li><a href="/attendance/my-qr/" aria-expanded="false">
                <div class="menu-icon"><svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="2" y="2" width="7" height="7" rx="1" stroke="#888888"/><rect x="11" y="2" width="7" height="7" rx="1" stroke="#888888"/><rect x="2" y="11" width="7" height="7" rx="1" stroke="#888888"/><rect x="11" y="11" width="7" height="7" rx="1" stroke="#888888"/></svg></div>
                <span class="nav-text">Mon code QR</span>
            </a></li>

            {# === ONBOARDING (in-process members) === #}
            {% if mp.is_in_onboarding %}
            <li class="menu-title">MON PARCOURS</li>

            <li><a href="/onboarding/dashboard/" aria-expanded="false">
                <div class="menu-icon"><svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="8" stroke="#888888"/><path d="M10 6v4" stroke="#888888" stroke-linecap="round"/><circle cx="10" cy="13.5" r=".5" fill="#888888"/></svg></div>
                <span class="nav-text">Mon statut</span>
            </a></li>

            {% if mp.membership_status == 'registered' or mp.membership_status == 'form_pending' or mp.membership_status == 'in_review' %}
            <li><a href="/onboarding/form/" aria-expanded="false">
                <div class="menu-icon"><svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.67 1.67H5a1.67 1.67 0 00-1.67 1.66v13.34A1.67 1.67 0 005 18.33h10a1.67 1.67 0 001.67-1.66V6.67l-5-5z" stroke="#888888" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                <span class="nav-text">Formulaire</span>
            </a></li>
            {% endif %}

            {% if mp.membership_status == 'in_training' %}
            <li><a href="/onboarding/training/" aria-expanded="false">
                <div class="menu-icon"><svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2.5 3.33h4.17a3.33 3.33 0 013.33 3.34V17.5A2.5 2.5 0 007.5 15H2.5V3.33z" stroke="#888888" stroke-linecap="round" stroke-linejoin="round"/><path d="M17.5 3.33h-4.17a3.33 3.33 0 00-3.33 3.34V17.5a2.5 2.5 0 012.5-2.5h5V3.33z" stroke="#888888" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                <span class="nav-text">Ma formation</span>
            </a></li>
            {% endif %}

            {% if mp.membership_status == 'interview_scheduled' %}
            <li><a href="/onboarding/interview/" aria-expanded="false">
                <div class="menu-icon"><svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="2.5" y="3.33" width="15" height="15" rx="1.67" stroke="#888888"/><path d="M13.33 1.67V5M6.67 1.67V5M2.5 8.33h15" stroke="#888888" stroke-linecap="round"/></svg></div>
                <span class="nav-text">Mon interview</span>
            </a></li>
            {% endif %}

            <li><a href="/attendance/my-history/" aria-expanded="false">
                <div class="menu-icon"><svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="8" stroke="#888888"/><path d="M10 5v5l3.33 1.67" stroke="#888888" stroke-linecap="round"/></svg></div>
                <span class="nav-text">Mes présences</span>
            </a></li>
            {% endif %}

            {# === FULL DASHBOARD (active members only) === #}
            {% if mp.has_full_access %}

            <li><a href="/reports/" aria-expanded="false">
                <div class="menu-icon"><svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2.5 7.5L10 1.67 17.5 7.5v9.17a1.67 1.67 0 01-1.67 1.66H4.17a1.67 1.67 0 01-1.67-1.66V7.5z" stroke="#888888" stroke-linecap="round" stroke-linejoin="round"/><path d="M7.5 18.33V10h5v8.33" stroke="#888888" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                <span class="nav-text">Tableau de bord</span>
            </a></li>

            <li><a class="has-arrow" href="javascript:void(0);" aria-expanded="false">
                <div class="menu-icon"><svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="7" r="4" stroke="#888888"/><path d="M3 18c0-3.87 3.13-7 7-7s7 3.13 7 7" stroke="#888888" stroke-linecap="round"/></svg></div>
                <span class="nav-text">Membres</span>
            </a>
                <ul aria-expanded="false">
                    <li><a href="/members/">Liste des membres</a></li>
                    <li><a href="/members/register/">Nouveau membre</a></li>
                    <li><a href="/members/directory/">Annuaire</a></li>
                    <li><a href="/members/groups/">Groupes</a></li>
                    <li><a href="/members/birthdays/">Anniversaires</a></li>
                    <li><a href="/members/departments/">Départements</a></li>
                </ul>
            </li>

            <li><a class="has-arrow" href="javascript:void(0);" aria-expanded="false">
                <div class="menu-icon"><svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.46 13.71c.01-1.58-.62-2.83-1.86-3.72-.96-.68-2.13-1.04-3.26-1.38C4 7.9 3.3 7.52 3.3 6.4c0-1.26 1.63-1.7 3.03-1.7 1.02 0 2.19.32 2.91.79l1.44-2.23A7.7 7.7 0 007.15 2.08V0H4.49v2.23C2.13 2.75.64 4.29.64 6.4c0 1.47.61 2.64 1.82 3.46.92.63 2.03.97 3.11 1.3 2.31.7 3.25 1.12 3.24 2.53v.01c0 1.18-1.57 1.6-2.91 1.6-1.27 0-2.65-.56-3.43-1.38L.54 15.75a7.1 7.1 0 003.95 2.08V20h2.66v-2.13c2.62-.37 4.31-1.95 4.31-4.16z" fill="#888888"/></svg></div>
                <span class="nav-text">Dons</span>
            </a>
                <ul aria-expanded="false">
                    <li><a href="/payments/donate/">Faire un don</a></li>
                    <li><a href="/donations/history/">Historique dons</a></li>
                    <li><a href="/payments/history/">Historique paiements</a></li>
                    <li><a href="/payments/recurring/">Dons récurrents</a></li>
                    <li><a href="/donations/admin/">Administration</a></li>
                    <li><a href="/donations/campaigns/">Campagnes</a></li>
                    <li><a href="/donations/receipts/">Reçus fiscaux</a></li>
                    {% if mp.role == 'admin' or mp.role == 'pastor' %}
                    <li><a href="/donations/delegations/">Délégations finance</a></li>
                    {% endif %}
                </ul>
            </li>

            <li><a class="has-arrow" href="javascript:void(0);" aria-expanded="false">
                <div class="menu-icon"><svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="2.5" y="3.33" width="15" height="15" rx="1.67" stroke="#888888"/><path d="M13.33 1.67V5M6.67 1.67V5M2.5 8.33h15" stroke="#888888" stroke-linecap="round"/></svg></div>
                <span class="nav-text">Événements</span>
            </a>
                <ul aria-expanded="false">
                    <li><a href="/events/">Liste</a></li>
                    <li><a href="/events/calendar/">Calendrier</a></li>
                </ul>
            </li>

            <li><a class="has-arrow" href="javascript:void(0);" aria-expanded="false">
                <div class="menu-icon"><svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 18.5l-4-4M15 18.5l4-4M10 2.5v3M4.93 4.93l2.12 2.12M15.07 4.93l-2.12 2.12M3.5 10.5h3M13.5 10.5h3M10 7.5a3 3 0 100 6 3 3 0 000-6z" stroke="#888888" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                <span class="nav-text">Cultes</span>
            </a>
                <ul aria-expanded="false">
                    <li><a href="/worship/services/">Services</a></li>
                    <li><a href="/worship/my-assignments/">Mes assignations</a></li>
                    {% if mp.role == 'admin' or mp.role == 'pastor' or mp.role == 'deacon' %}
                    <li><a href="/worship/services/create/">Créer un culte</a></li>
                    <li><a href="/worship/eligible/">Listes d'éligibilité</a></li>
                    {% endif %}
                </ul>
            </li>

            <li><a class="has-arrow" href="javascript:void(0);" aria-expanded="false">
                <div class="menu-icon"><svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="2.75" y="3.67" width="14.5" height="16.5" rx="1.83" stroke="#888888"/><path d="M8.25 10.08l2.75 2.75 8.25-8.25" stroke="#888888" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                <span class="nav-text">Volontaires</span>
            </a>
                <ul aria-expanded="false">
                    <li><a href="/volunteers/positions/">Positions</a></li>
                    <li><a href="/volunteers/schedule/">Horaires</a></li>
                    <li><a href="/volunteers/my-schedule/">Mon planning</a></li>
                    <li><a href="/volunteers/availability/">Disponibilités</a></li>
                    <li><a href="/volunteers/planned-absences/">Absences prévues</a></li>
                    <li><a href="/volunteers/swap-requests/">Échanges</a></li>
                </ul>
            </li>

            <li><a class="has-arrow" href="javascript:void(0);" aria-expanded="false">
                <div class="menu-icon"><svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.5 12.5a1.67 1.67 0 01-1.67 1.67H5.83L2.5 17.5V4.17c0-.92.75-1.67 1.67-1.67h11.66c.92 0 1.67.75 1.67 1.67v8.33z" stroke="#888888" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                <span class="nav-text">Communication</span>
            </a>
                <ul aria-expanded="false">
                    <li><a href="/communication/newsletters/">Bulletins</a></li>
                    <li><a href="/communication/notifications/">Notifications</a></li>
                    <li><a href="/communication/preferences/">Préférences</a></li>
                </ul>
            </li>

            <li><a href="/help-requests/" aria-expanded="false">
                <div class="menu-icon"><svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="8.33" stroke="#888888"/><path d="M7.58 7.5a2.5 2.5 0 014.86.83c0 1.67-2.5 2.5-2.5 2.5" stroke="#888888" stroke-linecap="round"/><circle cx="10" cy="14.17" r=".42" fill="#888888"/></svg></div>
                <span class="nav-text">Demandes d'aide</span>
            </a></li>

            <li><a href="/attendance/my-history/" aria-expanded="false">
                <div class="menu-icon"><svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="8" stroke="#888888"/><path d="M10 5v5l3.33 1.67" stroke="#888888" stroke-linecap="round"/></svg></div>
                <span class="nav-text">Mes présences</span>
            </a></li>

            <li class="menu-title">RAPPORTS</li>
            <li><a class="has-arrow" href="javascript:void(0);" aria-expanded="false">
                <div class="menu-icon"><svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16.67 17.5H3.33" stroke="#888888" stroke-linecap="round"/><rect x="3.33" y="14.17" width="3.33" height="3.33" rx=".83" stroke="#888888"/><rect x="8.33" y="10.83" width="3.33" height="6.67" rx=".83" stroke="#888888"/><rect x="13.33" y="7.5" width="3.33" height="10" rx=".83" stroke="#888888"/></svg></div>
                <span class="nav-text">Rapports</span>
            </a>
                <ul aria-expanded="false">
                    <li><a href="/reports/members/">Statistiques membres</a></li>
                    <li><a href="/reports/donations/">Rapport dons</a></li>
                    <li><a href="/reports/attendance/">Présence</a></li>
                    <li><a href="/reports/volunteers/">Volontaires</a></li>
                    <li><a href="/reports/birthdays/">Anniversaires</a></li>
                </ul>
            </li>
            {% endif %}

            {# === ADMIN SECTION === #}
            {% if mp.role == 'admin' or mp.role == 'pastor' or mp.role == 'deacon' %}
            <li class="menu-title">ADMINISTRATION</li>
            <li><a class="has-arrow" href="javascript:void(0);" aria-expanded="false">
                <div class="menu-icon"><svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16.67 10H13.33L11.67 17.5 8.33 2.5 6.67 10H3.33" stroke="#888888" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                <span class="nav-text">Adhésions</span>
            </a>
                <ul aria-expanded="false">
                    <li><a href="/onboarding/admin/pipeline/">Pipeline</a></li>
                    <li><a href="/onboarding/admin/courses/">Parcours</a></li>
                    <li><a href="/onboarding/admin/stats/">Statistiques</a></li>
                    <li><a href="/attendance/scanner/">Scanner QR</a></li>
                    <li><a href="/attendance/sessions/">Sessions</a></li>
                    <li><a href="/onboarding/admin/invitations/">Codes d'invitation</a></li>
                    <li><a href="/members/disciplinary/">Actions disciplinaires</a></li>
                </ul>
            </li>
            {% endif %}

            {% endif %}{# end if mp #}
            {% endwith %}
            {% endif %}{# end if authenticated #}
        </ul>
    </div>
</div>

<script>
// Active page highlighting
(function() {
    var path = window.location.pathname;
    var links = document.querySelectorAll('#menu a[href]');
    var bestMatch = null;
    var bestLen = 0;
    links.forEach(function(link) {
        var href = link.getAttribute('href');
        if (href && href !== '/' && href !== 'javascript:void(0);' && path.indexOf(href) === 0) {
            if (href.length > bestLen) {
                bestLen = href.length;
                bestMatch = link;
            }
        }
    });
    if (bestMatch) {
        bestMatch.classList.add('mm-active');
        var parentLi = bestMatch.closest('li');
        if (parentLi) parentLi.classList.add('mm-active');
        var parentUl = parentLi ? parentLi.closest('ul') : null;
        if (parentUl && parentUl.id !== 'menu') {
            parentUl.classList.add('mm-show');
            var parentParentLi = parentUl.closest('li');
            if (parentParentLi) parentParentLi.classList.add('mm-active');
        }
    }
})();

// Sidebar collapse memory (localStorage)
(function() {
    var STORAGE_KEY = 'sidebar_collapse_state';
    var saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    var menuItems = document.querySelectorAll('#menu > li > a.has-arrow');

    menuItems.forEach(function(arrow, idx) {
        var key = 'section_' + idx;
        var subUl = arrow.nextElementSibling;
        if (!subUl) return;

        // Restore state
        if (saved[key] === 'open') {
            subUl.classList.add('mm-show');
            arrow.closest('li').classList.add('mm-active');
        }
    });

    // Listen for MetisMenu events
    var menu = document.getElementById('menu');
    if (menu) {
        menu.addEventListener('shown.metisMenu', function(e) {
            saveState();
        });
        menu.addEventListener('hidden.metisMenu', function(e) {
            saveState();
        });
    }

    function saveState() {
        var state = {};
        menuItems.forEach(function(arrow, idx) {
            var subUl = arrow.nextElementSibling;
            if (subUl && subUl.classList.contains('mm-show')) {
                state['section_' + idx] = 'open';
            }
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }
})();
</script>
